name: NAT Traversal Server

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'The operational mode (e.g., direct-connect, hole-punch, xray)'
        required: true
        type: string
      client_info_payload:
        description: 'A hex-encoded string containing encrypted client data'
        required: true
        type: string

concurrency:
  group: nat-traversal-runner
  cancel-in-progress: true

jobs:
  server-runner:
    name: Server Runner
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Prepare Execution Environment
        run: |
          echo "Installing required system packages..."
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            stun-client nmap openssh-server
          echo "Installing Python dependencies..."
          pip3 install requests cryptography
          if [ ! -f bin/xray ]; then
            echo "Downloading Xray binary..."
            curl -s -f -L https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip -o xray.zip
            unzip -o -q xray.zip xray geoip.dat geosite.dat -d bin/
            rm xray.zip
          fi
          echo "$GITHUB_WORKSPACE/bin" >> $GITHUB_PATH
          chmod +x bin/* scripts/*.py

      - name: Execute Server Logic
        id: manager
        env:
          GHA_PAYLOAD_KEY: ${{ secrets.ENCRYPTION_KEY }}
          WG_PRIVATE_KEY: ${{ secrets.PRIVATEKEY }}
          XRAY_UUID: ${{ secrets.UUID }}

          INPUT_MODE: ${{ inputs.mode }}
          INPUT_CLIENT_INFO_PAYLOAD: ${{ inputs.client_info_payload }}
        run: |
          python3 scripts/action_server_manager.py
